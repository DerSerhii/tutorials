# Time zones - Часовые пояса

Когда поддержка часовых поясов включена, Django <br>
***хранит*** информацию о времени в UTC в базе данных, <br>
***использует*** внутренние объекты времени с учетом часовых поясов <br>
и ***переводит*** их в часовой пояс конечного пользователя в шаблонах и формах.

По умолчанию поддержка часовых поясов отключена. <br>
Чтобы включить ее, установите значение `USE_TZ = True` в файле настроек `settings.py`.

Поддержка часовых поясов использует `zoneinfo`, который является частью стандартной 
библиотеки Python, начиная с Python 3.9. <br>
Пакет `backports.zoneinfo` автоматически устанавливается вместе с Django, если вы используете Python 3.8.

## Наивные и осознанные объекты времени суток
Объекты Python `datetime.datetime` имеют атрибут `tzinfo`, который может быть 
использован для хранения информации о часовом поясе, представленной в виде экземпляра 
подкласса `datetime.tzinfo`. 

Когда этот атрибут установлен и описывает смещение, <br>
объект `datetime` является — **aware** (осознанным).

В противном случае он является **naive** (наивным).

Когда поддержка часовых поясов отключена, Django использует *наивные* объекты 
`datetime` в местном времени. Этого достаточно для многих случаев использования. <br>
В этом режиме, чтобы получить текущее время:
```python
import datetime
now = datetime.datetime.now()
```

Когда поддержка часовых поясов включена `USE_TZ=True`, Django использует объекты 
`datetime` с учетом часовых поясов. Если код создает объекты `datetime`,
они также должны быть осведомлены об этом. <br>
В этом режиме приведенный выше пример становится:
```python
from django.utils import timezone
now = timezone.now()
```

## Миграции 

### База данных PostgeSQL

Бэкенд **PostgreSQL** хранит время даты как `timestamp with time zone`. <br>
На практике это означает, что при хранении он преобразует время дат из часового пояса 
соединения в UTC, а при извлечении - из UTC в часовой пояс соединения.

Как следствие, PostgreSQL свободно переключаться между `USE_TZ = False` 
и `USE_TZ = True`. Часовой пояс соединения с базой данных будет установлен на 
`TIME_ZONE` или `UTC` соответственно, так что Django получит правильное время дат 
во всех случаях. <br>
***Не нужно выполнять никаких преобразований данных***

### Код

`django.utils.timezone` определяет несколько удобных методов для кода 
совместимости: <br>
`now()` — возврат осведомленного или наивного `datetime.datetime`, в зависимости от `settings.USE_TZ`<br>
`is_aware()` — определить, является ли данное `datetime.datetime` *осведомленным*<br>
`is_naive()` — определить, является ли данное `datetime.datetime` *наивным*<br>
`make_aware()` — сделать *наивное* `datetime.datetime` ***осведомленным*** в заданном часовом поясе <br>
`make_naive()` — сделать *осведомленое* 'datetime.datetime' ***наивным*** в заданном часовом поясе

Наконец, чтобы помочь вам найти код, который нуждается в обновлении, Django выдает предупреждение, когда вы пытаетесь сохранить наивное время даты в базе данных:
```commandline
RuntimeWarning: DateTimeField ModelName.field_name received a naive
datetime (2012-01-01 00:00:00) while time zone support is active.
```

Если есть строка "2012-02-21 10:28:45" и знаем, что она находится в "Europe/Helsinki"
временной зоне. <br>
Преобразование в *осведомленное* время:
```python
>>> import zoneinfo
>>> from django.utils.dateparse import parse_datetime
>>> naive = parse_datetime("2012-02-21 10:28:45")
>>> naive.replace(tzinfo=zoneinfo.ZoneInfo("Europe/Helsinki"))
datetime.datetime(2012, 2, 21, 10, 28, 45, tzinfo=zoneinfo.ZoneInfo(key='Europe/Helsinki'))
```

Python умеет сравнивать осведомленные времена дат, принимая во внимание смещения UTC,
когда это необходимо. Гораздо проще (и, возможно, быстрее) писать весь код модели и 
представления в UTC. Таким образом, в большинстве случаев времени в UTC, 
возвращаемого командой `django.utils.timezone.now()`, будет достаточно.

Однако для полноты картины, если вам действительно нужно местное время в текущем часовом поясе, 
вот как вы можете его получить:
```python
>>> from django.utils import timezone
>>> timezone.localtime(timezone.now())
datetime.datetime(2012, 3, 3, 20, 10, 53, 873365, tzinfo=zoneinfo.ZoneInfo(key='Europe/Paris'))
```

---
Документация на [Django.fun](https://django.fun/docs/django/ru/4.0/topics/i18n/timezones/)
<br>Родная документация [Django](https://docs.djangoproject.com/en/4.0/topics/i18n/timezones/#default-current-time-zone)
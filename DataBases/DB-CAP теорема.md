# CAP теорема

В **CAP**-теореме говорится, что в *распределенной системе* возможно выбрать 
только 2 из 3-х свойств:

- `<C>` **Consistency — Согласованность** <br>
Каждое чтение даст вам самую последнюю запись.

>         [Data v1] >>>------------------ Update v1 ---------------->>> [Data v1] 
>         SERVER #1 <<<----------------- OK Update v1 --------------<<< SERVER #2 
>          |   |                                                          |   |  
>          |   |                       q1          q2                     |   |
>          |   - <<<  — — Write — — — <<< | USER | >>> — — — Read — — >>> -   |  
>          - >>> — — — OK Write — — — <<< |      | <<< — — — — v1 — — — — <<< -

- `<A>` **Availability — Доступность** <br>
Каждый узел (не упавший) всегда успешно выполняет запросы (на чтение и запись). <br>
Часть узлов может быть не доступна.
>         [Data v1] >>>-------------- OK Read Query q2 --------------->>> [ X ]  
>         SERVER #1 <<<---------------- Read Query q2 ----------------<<< X X X  SERVER #2 — No available 
>          |   |                                                          |   |  
>          |   |                       q1          q2                     |   |
>          |   - <<<  — — Write — — — <<< | USER | >>> — — — Read — — >>> -   |  
>          - >>> — — — OK Write — — — <<< |      | <<< — — — — v1 — — — — <<< -
- 
- `<P>` **Partition tolerance — Устойчивость к Секционированию** <br>
Даже если между узлами нет связи, они продолжают работать независимо друг от друга.

>         [Data v1] >>>------XXX-------- No connection ------XXX----->>> [Data v0] 
>         SERVER #1 <<<------XXX-------- No connection ------XXX-----<<< SERVER #2 
>          |   |                                                          |   |  
>          |   |                       q1          q2                     |   |
>          |   - <<<  — — Write — — — <<< | USER | >>> — — — Read — — >>> -   |  
>          - >>> — — — OK Write — — — <<< |      | <<< — — — — v0 — — — — <<< -

## `CA`: Relational 
>MySQL, SQL Server, PostgreSQL 

### Посмотрим на PostgreSQL

Следующие пункты относятся к абстрактной распределенной БД Postgresql:
- Репликация Master-Slave — одно из распространенных решений
- Синхронизация с Master в асинхронном / синхронном режиме
- Система транзакций использует двухфазный коммит для обеспечения consistency
- Если возникает partition, вы не можете взаимодейстовать с системой (в основном случае)

Таким образом, система не может продолжать работу в случае `partition`, но 
обеспечивает `strong consistency` и `availability`. Это система `CA`!

## `CP`: Bigtable 
>MongoDB, Redis

### Посмотрим на MongoDB

Следующие пункты относятся к абстрактной распределенной БД MongoDB:
- MongoDB обеспечивает `strong consistency`, потому что это система с одним 
Master узлом, и все записи идут по умолчанию в него.
- Автоматическая смена мастера, в случае отделения его от остальных узлов.
- В случае разделения сети, система прекратит принимать записи до тех пор, 
пока не убедится, что может безопасно завершить их.

Таким образом, система может продолжать работу в случае разделения сети, но 
теряется `availability` всех узлов. Это `CP` система!

## `AP`: Amazon Dynamo
>DynamoDB, Cassandra, CouchDB

### Посмотрим на Cassandra
Cassandra использует схему репликации master-master, что фактически 
означает `AP` систему, в которой разделение сети приводит к самодостаточному 
функционированию всех узлов.
